<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PotPal - Tr·ª£ l√Ω ChƒÉm s√≥c C√¢y tr·ªìng</title>
    <link rel="icon" type="image/jpeg" href="favicon.jpg"> 
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        /* Phong c√°ch PotPal M·ªöI (M√†u xanh l√° r·ª±c r·ª° v√† Poppins) */
        body {
            font-family: 'Poppins', sans-serif; /* D√πng Poppins */
            background-color: #f7fefc; /* N·ªÅn tr·∫Øng xanh r·∫•t nh·∫π */
        }
        .file-input-label {
            transition: all 0.3s ease-in-out;
            cursor: pointer;
            border-color: #00b894; /* Primary Green m·ªõi */
        }
        .file-input-label:hover {
            background-color: #00b894; /* Primary Green m·ªõi */
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(0, 184, 148, 0.4);
        }
        .btn-primary {
            background-color: #00b894; /* Primary Green m·ªõi */
            transition: all 0.2s ease-in-out;
        }
        .btn-primary:hover:not(:disabled) {
            background-color: #00997c; /* T·ªëi h∆°n m·ªôt ch√∫t khi hover */
            transform: translateY(-2px);
            box-shadow: 0 15px 20px -5px rgba(0, 184, 148, 0.5);
        }
        .btn-primary:active:not(:disabled) {
            transform: scale(0.98); /* Hi·ªáu ·ª©ng nh·∫•n n√∫t */
            box-shadow: none;
        }

        /* Th√™m hi·ªáu ·ª©ng cho Chat Button */
        #chat-toggle-btn {
            background-color: #00b894;
            transition: all 0.3s ease-in-out;
        }
        #chat-toggle-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 0 0 6px rgba(0, 184, 148, 0.5);
        }
        
    </style>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        // M√†u xanh m·ªõi: R·ª±c r·ª° v√† th√¢n thi·ªán h∆°n
                        'primary-green': '#00b894', 
                        'light-green': '#e0fffa', // M√†u n·ªÅn nh·∫π cho c√°c kh·ªëi
                    },
                    boxShadow: {
                        'fabulous': '0 20px 25px -5px rgba(0, 184, 148, 0.2), 0 10px 10px -5px rgba(0, 184, 148, 0.04)',
                        'xl-green': '0 20px 25px -5px rgba(0, 184, 148, 0.3), 0 10px 10px -5px rgba(0, 184, 148, 0.1)',
                    }
                }
            }
        }
    </script>
</head>
<body class="min-h-screen flex items-start justify-center p-4 md:p-10">

    <div id="app-container" class="w-full max-w-xl bg-white rounded-3xl shadow-fabulous p-8 md:p-12 border border-light-green mt-8 transform transition duration-500 hover:scale-[1.01]">

        <header class="text-center mb-8 border-b-4 border-primary-green pb-5">
            <h1 class="text-5xl font-extrabold text-primary-green mb-1 flex items-center justify-center">
                <i class="fas fa-seedling mr-3 animate-pulse"></i> PotPal
            </h1>
            <p class="text-xl text-gray-700 font-semibold mt-1">Tr·ª£ l√Ω ch·∫©n ƒëo√°n s·ª©c kh·ªèe c√¢y tr·ªìng</p>
            <p class="text-lg font-extrabold text-pink-500 mt-2 animate-bounce">Tr·ª£ l√Ω c√¢y tr·ªìng d·ªÖ th∆∞∆°ng c·ªßa b·∫°n ü™¥üíñ</p>
        </header>

        <section id="input-section" class="mb-6">
            
            <p class="text-sm text-center text-red-600 font-medium mb-5 p-3 bg-red-100 rounded-xl border-2 border-red-300 shadow-inner">
                <i class="fas fa-exclamation-triangle mr-2"></i> M·ªçi ƒë√°nh gi√° ƒë·ªÅu l√† s∆° b·ªô th√¥ng qua h√¨nh ·∫£nh. H√£y h·ªèi chuy√™n gia ƒë·ªÉ ƒë∆∞·ª£c k·∫øt qu·∫£ ch√≠nh x√°c nh·∫•t.
            </p>

            <div class="mb-6 p-5 bg-light-green rounded-xl border-2 border-primary-green shadow-lg">
                <label class="block text-xl font-bold text-primary-green mb-3 flex items-center">
                    <i class="fas fa-microscope mr-3"></i> Ch·ªçn Chi Ti·∫øt C·∫ßn Ph√¢n T√≠ch:
                </label>
                <select id="analysis-mode" class="w-full p-3 border-2 border-primary-green rounded-xl shadow-md focus:ring-pink-500 focus:border-pink-500 text-gray-800 font-medium transition duration-200 hover:border-pink-400">
                    <option value="leaf">ƒê√°nh gi√° L√° (Ph√°t hi·ªán B·ªánh, Thi·∫øu ch·∫•t)</option>
                    <option value="soil">ƒê√°nh gi√° ƒê·∫•t/Gi√° th·ªÉ (Ki·ªÉm tra ƒê·ªô ·∫©m, N·∫•m m·ªëc)</option>
                </select>
            </div>
            
            <div id="image-preview-container" class="mb-5 hidden">
                <img id="image-preview" class="w-full h-auto max-h-72 object-contain rounded-2xl border-4 border-primary-green p-2 mb-3 shadow-xl-green" alt="Xem tr∆∞·ªõc ·∫£nh">
                <button onclick="resetApp()" class="w-full py-3 bg-red-500 text-white font-bold rounded-xl hover:bg-red-600 transition duration-200 transform active:scale-95 shadow-lg">
                    <i class="fas fa-undo mr-2"></i> Ch·ªçn ·∫¢nh Kh√°c
                </button>
            </div>
            
            <input type="file" id="plant-image" accept="image/*" class="hidden" onchange="previewImage(event)">
            
            <label for="plant-image" id="upload-label" class="file-input-label flex flex-col items-center justify-center h-52 border-4 border-dashed text-primary-green rounded-2xl bg-light-green shadow-inner p-4">
                <i class="fas fa-cloud-upload-alt text-6xl mb-3"></i>
                <span class="text-2xl font-extrabold">T·∫£i ·∫£nh c√¢y tr·ªìng b·ªã b·ªánh</span>
                <span class="text-sm mt-2 text-gray-500 font-semibold">(File ·∫£nh < 5MB)</span>
            </label>

            <p class="text-base text-center text-primary-green font-semibold mt-4 mb-6 p-3 bg-green-100 rounded-xl border-2 border-green-300 flex items-center justify-center space-x-2 shadow-md">
                <i class="fas fa-camera-retro"></i> 
                <span id="instruction-text">H√£y ch·ª•p ·∫£nh c√¢y bao qu√°t ƒë·ªÉ c√≥ th·ªÉ ƒë∆∞a k·∫øt qu·∫£ ƒë√°nh gi√° t·ªët nh·∫•t ·∫° üòâ</span>
            </p>

            <button id="diagnose-button" onclick="diagnosePlant()" class="w-full py-4 btn-primary text-white font-extrabold text-xl rounded-2xl shadow-xl-green disabled:opacity-50" disabled>
                <i class="fas fa-stethoscope mr-3"></i> B·∫Øt ƒë·∫ßu Ph√¢n t√≠ch
            </button>
        </section>

        <section id="loading-indicator" class="hidden text-center p-10 bg-light-green rounded-2xl shadow-inner">
            <div class="animate-spin inline-block w-10 h-10 border-4 border-t-4 border-primary-green border-t-transparent rounded-full mb-4"></div>
            <p class="text-xl font-bold text-primary-green">PotPal ƒëang 'ng·ª≠i' ·∫£nh, ph√¢n t√≠ch 'cƒÉng ƒë√©t' lu√¥n... üßê</p>
        </section>

        <section id="results-section" class="hidden mt-10 border-t-4 border-primary-green pt-8">
            <h2 id="results-title" class="text-3xl font-extrabold text-gray-800 border-l-6 border-pink-500 pl-4 pb-2 mb-8">
                <i class="fas fa-clipboard-check mr-3 text-primary-green"></i> K·∫øt Qu·∫£ Ch·∫©n ƒêo√°n
            </h2>

            <div id="compliment-card" class="hidden text-center bg-yellow-100 p-8 rounded-2xl shadow-xl border-4 border-yellow-400 transform rotate-[-1deg]">
                <i class="fas fa-star-of-life text-5xl text-yellow-600 mb-4 animate-bounce"></i>
                <p id="compliment-text" class="text-2xl font-extrabold text-yellow-800"></p>
                <p class="text-lg text-yellow-700 mt-2">ƒê√∫ng l√† kh√¥ng ph·∫£i c√¢y r·ªìi, xin l·ªói c·∫≠u nha! ü•≤</p>
            </div>
            
            <div id="diagnosis-content" class="space-y-6">
                
                <div id="diagnosis-card" class="bg-white p-5 rounded-2xl shadow-xl border-t-8 border-primary-green transform hover:scale-[1.02] transition duration-300">
                    <p class="text-xl font-bold text-gray-800"><span id="mode-label" class="text-primary-green">T√¨nh Tr·∫°ng L√°</span>: <span id="result-status" class="font-extrabold text-red-600 ml-2"></span></p>
                    <p class="text-xl font-bold text-gray-800 mt-2"><span id="mode-diagnosis-label" class="text-primary-green">Ch·∫©n ƒêo√°n S∆° B·ªô</span>: <span id="result-diagnosis" class="text-gray-900 font-semibold ml-2"></span></p>
                </div>
    
                <div class="bg-light-green p-6 rounded-2xl border-2 border-primary-green shadow-lg">
                    <h3 class="text-2xl font-bold text-primary-green mb-3 flex items-center">
                        <i class="fas fa-hand-holding-heart mr-3 text-pink-500"></i> H∆∞·ªõng D·∫´n ChƒÉm S√≥c Th√¢n Thi·ªán
                    </h3>
                    <div id="result-recommendations" class="text-gray-700 whitespace-pre-wrap leading-loose text-base"></div>
                </div>

                <div id="supplement-suggestion-container" class="hidden bg-gray-100 p-6 rounded-2xl border border-gray-300 shadow-md">
                    <h3 class="text-xl font-bold text-gray-700 mb-3 flex items-center">
                        <i class="fas fa-vial mr-3 text-blue-500"></i> G·ª£i √ù B·ªï Sung (Dinh D∆∞·ª°ng & Thu·ªëc)
                    </h3>
                    <ul id="supplement-list" class="list-disc list-inside text-gray-700 space-y-2 text-base ml-4">
                        </ul>
                </div>
            </div>
        </section>

        <div id="message-box" class="fixed inset-0 bg-black bg-opacity-60 hidden items-center justify-center p-4 z-50 transition duration-300" onclick="hideMessageBox()">
            <div class="bg-white p-8 rounded-3xl shadow-2xl max-w-sm w-full transform scale-100 transition duration-300" onclick="event.stopPropagation()">
                <h3 id="message-box-title" class="text-2xl font-extrabold mb-4 text-red-600 border-b-2 border-red-300 pb-2">L·ªói</h3>
                <p id="message-box-content" class="text-gray-700 mb-6 text-lg">C√≥ l·ªói x·∫£y ra.</p>
                <button onclick="hideMessageBox()" class="w-full py-3 bg-red-600 text-white font-bold rounded-xl hover:bg-red-700 transition duration-150 transform active:scale-95 shadow-lg">
                    <i class="fas fa-times-circle mr-2"></i> ƒê√≥ng
                </button>
            </div>
        </div>

    </div>

    <div id="chat-widget" class="fixed bottom-4 right-4 md:bottom-10 md:right-10 z-40">
        <button id="chat-toggle-btn" onclick="toggleChat()" class="bg-primary-green hover:bg-green-700 text-white p-5 rounded-full shadow-2xl transition duration-300 transform focus:outline-none focus:ring-8 focus:ring-primary-green focus:ring-opacity-50">
            <i class="fas fa-comment-dots text-3xl"></i>
        </button>

        <div id="chat-window" class="hidden bg-white rounded-2xl shadow-2xl border-4 border-primary-green flex flex-col w-72 md:w-80 h-[450px] absolute bottom-20 right-0 transform origin-bottom-right scale-100 transition duration-300">
            <div class="p-4 bg-primary-green text-white rounded-t-xl flex justify-between items-center shadow-md">
                <span class="text-xl font-bold"><i class="fas fa-robot mr-2"></i> PotPal Chat üíñ</span>
                <button onclick="toggleChat()" class="text-white hover:text-pink-200 transition">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>

            <div id="chat-messages" class="flex-grow p-4 overflow-y-auto space-y-4 bg-light-green">
                <div class="flex justify-start">
                    <div class="bg-white text-gray-800 p-3 rounded-xl max-w-[85%] shadow-md text-sm border-2 border-green-200">
                        <i class="fas fa-leaf text-primary-green mr-1"></i> Ch√†o c·∫≠u, PotPal ƒë√¢y! C·∫≠u c√≥ c√¢u h·ªèi n√†o v·ªÅ c√¢y tr·ªìng kh√¥ng? C·ª© h·ªèi t·ªõ nh√©! üòä
                    </div>
                </div>
            </div>

            <div class="p-4 border-t border-green-300 bg-white flex items-center rounded-b-xl">
                <input type="text" id="chat-input" placeholder="H·ªèi PotPal..." class="w-full p-3 border-2 border-gray-300 rounded-xl focus:ring-primary-green focus:border-primary-green text-sm transition duration-200" onkeydown="if(event.key === 'Enter') sendChatMessage()">
                <button onclick="sendChatMessage()" id="chat-send-btn" class="ml-2 p-3 bg-primary-green text-white rounded-xl hover:bg-green-700 transition disabled:opacity-50 transform active:scale-95 shadow-lg">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
        </div>
    </div>


    <script type="module">
        // Kh√≥a API ƒë∆∞·ª£c nh√∫ng tr·ª±c ti·∫øp v√†o code theo y√™u c·∫ßu c·ªßa ng∆∞·ªùi d√πng
        const API_KEY = "AIzaSyDX4sbq_x_NdsTJmhVjTAOpexgncPmqrFU"; // D√πng key c·ªßa ng∆∞·ªùi d√πng
        const API_URL_BASE = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${API_KEY}`;
        
        // C·∫•u h√¨nh Backoff cho API Call
        const MAX_RETRIES = 5;
        const INITIAL_DELAY_MS = 1000; 

        // Global Chat State
        let chatHistory = [];

        const fileInput = document.getElementById('plant-image');
        const previewImg = document.getElementById('image-preview');
        const uploadLabel = document.getElementById('upload-label');
        const diagnoseButton = document.getElementById('diagnose-button');
        const loadingIndicator = document.getElementById('loading-indicator');
        const resultsSection = document.getElementById('results-section');
        const imagePreviewContainer = document.getElementById('image-preview-container');
        const supplementContainer = document.getElementById('supplement-suggestion-container');
        const supplementList = document.getElementById('supplement-list');
        const analysisModeSelect = document.getElementById('analysis-mode'); 
        const instructionText = document.getElementById('instruction-text');
        const modeLabel = document.getElementById('mode-label');
        const modeDiagnosisLabel = document.getElementById('mode-diagnosis-label');

        const resultsTitle = document.getElementById('results-title');
        const complimentCard = document.getElementById('compliment-card');
        const complimentText = document.getElementById('compliment-text');
        const diagnosisContent = document.getElementById('diagnosis-content');
        const resultRecommendations = document.getElementById('result-recommendations');
        const resultStatus = document.getElementById('result-status');
        const resultDiagnosis = document.getElementById('result-diagnosis');
        
        // C√°c bi·∫øn m·ªõi cho Chatbot
        const chatWindow = document.getElementById('chat-window');
        const chatMessages = document.getElementById('chat-messages');
        const chatInput = document.getElementById('chat-input');
        const chatSendBtn = document.getElementById('chat-send-btn');


        let base64Image = null;
        let imageMimeType = null; 

        // Event listener cho vi·ªác thay ƒë·ªïi ch·∫ø ƒë·ªô ph√¢n t√≠ch
        analysisModeSelect.addEventListener('change', (e) => {
            const mode = e.target.value;
            if (mode === 'leaf') {
                uploadLabel.querySelector('span').textContent = 'T·∫£i ·∫£nh c√¢y tr·ªìng b·ªã b·ªánh';
                instructionText.textContent = 'H√£y ch·ª•p ·∫£nh c√¢y bao qu√°t ƒë·ªÉ c√≥ th·ªÉ ƒë∆∞a k·∫øt qu·∫£ ƒë√°nh gi√° t·ªët nh·∫•t ·∫° üòâ';
                modeLabel.textContent = 'T√¨nh Tr·∫°ng L√°';
                modeDiagnosisLabel.textContent = 'Ch·∫©n ƒêo√°n S∆° B·ªô';
            } else if (mode === 'soil') {
                uploadLabel.querySelector('span').textContent = 'T·∫£i ·∫£nh ƒê·∫•t/Gi√° th·ªÉ c·∫ßn ph√¢n t√≠ch';
                instructionText.textContent = 'H√£y ch·ª•p r√µ chi ti·∫øt ƒë·∫•t/gi√° th·ªÉ ƒë·ªÉ PotPal nh·∫≠n di·ªán nha üòâ';
                modeLabel.textContent = 'T√¨nh Tr·∫°ng ƒê·∫•t';
                modeDiagnosisLabel.textContent = 'ƒê√°nh Gi√° T·ªïng Quan';
            }
            resetApp(); 
        });

        /**
         * H√†m T·∫Øt/M·ªü Chat Widget
         */
        window.toggleChat = () => {
            chatWindow.classList.toggle('hidden');
            // Th√™m hi·ªáu ·ª©ng transform ƒë·ªÉ c·ª≠a s·ªï chat hi·ªán ra m∆∞·ª£t m√† h∆°n
            if (!chatWindow.classList.contains('hidden')) {
                chatWindow.style.transform = 'scale(1)';
                chatInput.focus();
                chatMessages.scrollTop = chatMessages.scrollHeight; // Cu·ªôn xu·ªëng d∆∞·ªõi khi m·ªü
            } else {
                chatWindow.style.transform = 'scale(0.8)';
            }
        }

        /**
         * Render m·ªôt tin nh·∫Øn m·ªõi v√†o c·ª≠a s·ªï chat.
         */
        function renderMessage(sender, text) {
            const messageWrapper = document.createElement('div');
            messageWrapper.className = sender === 'user' ? 'flex justify-end' : 'flex justify-start';

            const messageBubble = document.createElement('div');
            
            // Chuy·ªÉn Markdown c∆° b·∫£n (**bold**, *italic*) sang HTML
            const formattedText = text
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\*(.*?)\*/g, '<em>$1</em>')
                .replace(/\n/g, '<br>');

            messageBubble.innerHTML = formattedText;
            
            if (sender === 'user') {
                messageBubble.className = 'bg-blue-500 text-white p-3 rounded-xl max-w-[85%] shadow-md text-sm';
            } else {
                // Thay ƒë·ªïi m√†u n·ªÅn tin nh·∫Øn c·ªßa model
                messageBubble.className = 'bg-white text-gray-800 p-3 rounded-xl max-w-[85%] shadow-md text-sm border-2 border-green-200';
                messageBubble.innerHTML = `<i class="fas fa-leaf text-primary-green mr-1"></i> ${formattedText}`;
            }

            messageWrapper.appendChild(messageBubble);
            chatMessages.appendChild(messageWrapper);
            
            // Cu·ªôn xu·ªëng tin nh·∫Øn m·ªõi nh·∫•t
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        /**
         * G·ª≠i tin nh·∫Øn t·ª´ ng∆∞·ªùi d√πng v√† g·ªçi API cho Chatbot.
         */
        window.sendChatMessage = async () => {
            const userText = chatInput.value.trim();
            if (userText === '') return;

            // 1. C·∫≠p nh·∫≠t UI v√† tr·∫°ng th√°i
            chatInput.value = '';
            chatSendBtn.disabled = true;
            renderMessage('user', userText);

            // Th√™m tin nh·∫Øn ng∆∞·ªùi d√πng v√†o l·ªãch s·ª≠
            chatHistory.push({ role: 'user', parts: [{ text: userText }] });

            // Th√™m tin nh·∫Øn ch·ªù (Loading)
            const loadingWrapper = document.createElement('div');
            loadingWrapper.className = 'flex justify-start';
            const loadingBubble = document.createElement('div');
            // Th√™m hi·ªáu ·ª©ng loading
            loadingBubble.className = 'bg-white text-gray-800 p-3 rounded-xl max-w-[85%] shadow-md animate-pulse text-sm border-2 border-green-200';
            loadingBubble.innerHTML = `<i class="fas fa-leaf text-primary-green mr-1 animate-spin"></i> PotPal ƒëang nghƒ©...`;
            loadingWrapper.appendChild(loadingBubble);
            chatMessages.appendChild(loadingWrapper);
            chatMessages.scrollTop = chatMessages.scrollHeight;

            try {
                // 2. Chu·∫©n b·ªã System Instruction ri√™ng cho chat (ƒë√£ lo·∫°i b·ªè 'c∆∞ t√™' nh∆∞ng cho ph√©p 'd·ªÖ th∆∞∆°ng')
                const chatSystemInstruction = {
                    parts: [{ 
                        text: "B·∫°n l√† PotPal, m·ªôt tr·ª£ l√Ω chatbot v·ªÅ chƒÉm s√≥c c√¢y tr·ªìng. H√£y gi·ªØ gi·ªçng vƒÉn th√¢n thi·ªán, d·ªÖ th∆∞∆°ng, d√πng t·ª´ ng·ªØ hi·ªán ƒë·∫°i v√† tr·∫£ l·ªùi ng·∫Øn g·ªçn, tr·ª±c ti·∫øp cho c√¢u h·ªèi c·ªßa ng∆∞·ªùi d√πng. Tr√°nh tr·∫£ l·ªùi b·∫±ng JSON. KH√îNG d√πng t·ª´ 'c∆∞ t√™' hay c√°c t·ª´ c√≥ s·∫Øc th√°i t∆∞∆°ng t·ª±." 
                    }]
                };

                // 3. Chu·∫©n b·ªã Payload cho chat (s·ª≠ d·ª•ng l·ªãch s·ª≠)
                const chatPayload = {
                    contents: chatHistory,
                    systemInstruction: chatSystemInstruction
                };
                
                // 4. G·ªçi API
                const jsonResponse = await fetchWithExponentialBackoff(chatPayload);
                
                // 5. X·ª≠ l√Ω ph·∫£n h·ªìi
                const modelText = jsonResponse.candidates?.[0]?.content?.parts?.[0]?.text;
                
                if (!modelText) {
                    throw new Error("Ph·∫£n h·ªìi chat r·ªóng.");
                }

                // 6. C·∫≠p nh·∫≠t UI v√† l·ªãch s·ª≠
                chatHistory.push({ role: 'model', parts: [{ text: modelText }] });

                // X√≥a tin nh·∫Øn ch·ªù v√† th√™m tin nh·∫Øn th·ª±c t·∫ø
                chatMessages.removeChild(loadingWrapper);
                renderMessage('model', modelText);

            } catch (error) {
                console.error("L·ªói Chatbot:", error);
                
                // X√≥a tin nh·∫Øn ch·ªù v√† th√™m th√¥ng b√°o l·ªói
                chatMessages.removeChild(loadingWrapper);
                renderMessage('model', 'Xin l·ªói c·∫≠u, t·ªõ b·ªã l·ªói r·ªìi. C·∫≠u th·ª≠ l·∫°i nh√©! ü•≤');
                
            } finally {
                chatSendBtn.disabled = false;
                chatInput.focus();
            }
        }

        /**
         * Hi·ªÉn th·ªã h·ªôp tho·∫°i th√¥ng b√°o t√πy ch·ªânh (thay th·∫ø cho alert).
         */
        window.showMessageBox = (title, content, type = 'error') => {
            const box = document.getElementById('message-box');
            const titleElement = document.getElementById('message-box-title');
            const button = box.querySelector('button');

            titleElement.textContent = title;
            document.getElementById('message-box-content').textContent = content;

            if (type === 'error') {
                titleElement.className = 'text-2xl font-extrabold mb-4 text-red-600 border-b-2 border-red-300 pb-2';
                button.className = 'w-full py-3 bg-red-600 text-white font-bold rounded-xl hover:bg-red-700 transition duration-150 transform active:scale-95 shadow-lg';
            } else if (type === 'info') {
                titleElement.className = 'text-2xl font-extrabold mb-4 text-primary-green border-b-2 border-green-300 pb-2';
                button.className = 'w-full py-3 bg-primary-green text-white font-bold rounded-xl hover:bg-green-700 transition duration-150 transform active:scale-95 shadow-lg';
            }
            
            box.classList.remove('hidden');
            box.classList.add('flex');
        }

        window.hideMessageBox = () => {
            document.getElementById('message-box').classList.add('hidden');
            document.getElementById('message-box').classList.remove('flex');
        }

        /**
         * Tr√≠ch xu·∫•t JSON object t·ª´ chu·ªói text.
         */
        function extractJsonFromText(text) {
            // Regex t√¨m JSON object: b·∫Øt ƒë·∫ßu b·∫±ng { v√† k·∫øt th√∫c b·∫±ng } (s·ª≠ d·ª•ng /s ƒë·ªÉ . kh·ªõp v·ªõi newline)
            const match = text.match(/\{[\s\S]*\}/s); 
            if (match) {
                let jsonString = match[0];
                
                // Lo·∫°i b·ªè c√°c k√Ω t·ª± d∆∞ th·ª´a th∆∞·ªùng g·∫∑p do AI th√™m v√†o:
                jsonString = jsonString.replace(/```json/g, '').replace(/```/g, '').trim();

                try {
                    // C·ªë g·∫Øng parse n·ªôi dung b√™n trong d·∫•u ngo·∫∑c nh·ªçn
                    return JSON.parse(jsonString);
                } catch (e) {
                    console.error("L·ªói khi parse JSON ƒë√£ tr√≠ch xu·∫•t:", e, "JSON string:", jsonString);
                    // Hi·ªÉn th·ªã th√¥ng b√°o chi ti·∫øt h∆°n v·ªÅ l·ªói parsing
                    throw new Error("Ph·∫£n h·ªìi c·ªßa AI kh√¥ng ·ªü ƒë·ªãnh d·∫°ng JSON h·ª£p l·ªá (Parsing Failed).");
                }
            }
            console.error("L·ªói: Kh√¥ng t√¨m th·∫•y JSON object trong ph·∫£n h·ªìi c·ªßa AI. Raw text:", text);
            throw new Error("Kh√¥ng t√¨m th·∫•y JSON object trong ph·∫£n h·ªìi c·ªßa AI.");
        }

        /**
         * Xem tr∆∞·ªõc ·∫£nh ƒë∆∞·ª£c ch·ªçn v√† chuy·ªÉn ƒë·ªïi sang Base64
         */
        window.previewImage = (event) => {
            const file = event.target.files[0];
            if (!file) {
                diagnoseButton.disabled = true;
                return;
            }

            if (file.size > 5 * 1024 * 1024) { // Gi·ªõi h·∫°n 5MB
                showMessageBox("L·ªói K√≠ch Th∆∞·ªõc ·∫¢nh", "Vui l√≤ng ch·ªçn ·∫£nh c√≥ k√≠ch th∆∞·ªõc d∆∞·ªõi 5MB.");
                diagnoseButton.disabled = true;
                fileInput.value = '';
                return;
            }

            const reader = new FileReader();
            reader.onloadend = () => {
                const base64String = reader.result.split(',')[1];
                base64Image = base64String;
                imageMimeType = file.type;

                previewImg.src = reader.result;
                imagePreviewContainer.classList.remove('hidden');
                uploadLabel.classList.add('hidden');
                diagnoseButton.disabled = false;
            };
            reader.readAsDataURL(file);
        }

        /**
         * Reset giao di·ªán v√† tr·∫°ng th√°i ·ª©ng d·ª•ng
         */
        window.resetApp = () => {
            fileInput.value = '';
            base64Image = null;
            imageMimeType = null;
            
            imagePreviewContainer.classList.add('hidden');
            uploadLabel.classList.remove('hidden');
            diagnoseButton.disabled = true;
            loadingIndicator.classList.add('hidden');
            resultsSection.classList.add('hidden');

            resultStatus.textContent = '';
            resultDiagnosis.textContent = '';
            resultRecommendations.innerHTML = '';
            supplementList.innerHTML = '';
            supplementContainer.classList.add('hidden');
            complimentCard.classList.add('hidden');
            diagnosisContent.classList.remove('hidden');

            // Reset Chat History
            chatHistory = [];
            // Gi·ªØ l·∫°i tin nh·∫Øn ch√†o m·ª´ng m·∫∑c ƒë·ªãnh
            chatMessages.innerHTML = `
                <div class="flex justify-start">
                    <div class="bg-white text-gray-800 p-3 rounded-xl max-w-[85%] shadow-md text-sm border-2 border-green-200">
                        <i class="fas fa-leaf text-primary-green mr-1"></i> Ch√†o c·∫≠u, PotPal ƒë√¢y! C·∫≠u c√≥ c√¢u h·ªèi n√†o v·ªÅ c√¢y tr·ªìng kh√¥ng? C·ª© h·ªèi t·ªõ nh√©! üòä
                    </div>
                </div>
            `;
        }

        /**
         * T·∫°o System Instruction cho LLM (ch·∫ø ƒë·ªô ch·∫©n ƒëo√°n ·∫£nh) - ƒê√£ b·ªè 'c∆∞ t√™'
         */
        function getSystemInstruction() {
            const mode = analysisModeSelect.value;
            
            // ƒê√£ c·∫≠p nh·∫≠t System Instruction ƒë·ªÉ lo·∫°i b·ªè 'c∆∞ t√™' nh∆∞ng cho ph√©p 'd·ªÖ th∆∞∆°ng'
            const commonInstruction = `B·∫°n l√† PotPal, chuy√™n gia ch·∫©n ƒëo√°n c√¢y tr·ªìng/ƒë·∫•t v·ªõi gi·ªçng vƒÉn th√¢n thi·ªán, d·ªÖ th∆∞∆°ng v√† d√πng t·ª´ ng·ªØ Vi·ªát Nam hi·ªán ƒë·∫°i (nh∆∞ 'xin l·ªói c·∫≠u'). KH√îNG d√πng t·ª´ 'c∆∞ t√™' hay c√°c t·ª´ c√≥ s·∫Øc th√°i t∆∞∆°ng t·ª±.

            B·∫°n PH·∫¢I tr·∫£ l·ªùi b·∫±ng m·ªôt kh·ªëi JSON DUY NH·∫§T theo c·∫•u tr√∫c sau (KH√îNG th√™m b·∫•t k·ª≥ vƒÉn b·∫£n gi·ªõi thi·ªáu n√†o b√™n ngo√†i JSON ho·∫∑c Markdown block):
            {
              "is_plant": [true/false],
              "status": "T√≥m t·∫Øt t√¨nh tr·∫°ng c√¢y tr·ªìng/ƒë·∫•t (V√≠ d·ª•: 'Thi·∫øu Kali nh·∫π' ho·∫∑c 'N·∫•m m·ªëc b·ªÅ m·∫∑t ƒë·∫•t').",
              "diagnosis": "Ch·∫©n ƒëo√°n chi ti·∫øt v√† nguy√™n nh√¢n (2-3 c√¢u).",
              "recommendations": "L·ªùi khuy√™n C·ª§ TH·ªÇ, H√ÄNH ƒê·ªòNG ƒë∆∞·ª£c (c√°c b∆∞·ªõc ph·∫£i l√†m) d∆∞·ªõi d·∫°ng danh s√°ch g·∫°ch ƒë·∫ßu d√≤ng Markdown (- B∆∞·ªõc 1: C·∫Øt b·ªè l√°, - B∆∞·ªõc 2: B·ªï sung Calci). KH√îNG d√πng c√°c c√¢u n√≥i chung chung hay h·ª©a h·∫πn.",
              "supplements": ["G·ª£i √Ω 3-5 lo·∫°i ph√¢n b√≥n/s·∫£n ph·∫©m b·ªï sung c·ª• th·ªÉ (V√≠ d·ª•: NPK 20-20-20, Thu·ªëc n·∫•m Mancozeb)."],
              "compliment": "M·ªôt l·ªùi khen ho·∫∑c c√¢u n√≥i d·ªÖ th∆∞∆°ng n·∫øu is_plant: false. L∆∞u √Ω: th√¥ng b√°o n√†y ph·∫£i ph√π h·ª£p v·ªõi ch·∫ø ƒë·ªô ƒëang ch·ªçn (l√° hay ƒë·∫•t)."
            }`;

            if (mode === 'leaf') {
                return commonInstruction + `\n\nH√£y ph√¢n t√≠ch h√¨nh ·∫£nh n√†y ƒë·ªÉ t√¨m b·ªánh ho·∫∑c thi·∫øu ch·∫•t dinh d∆∞·ª°ng tr√™n l√° c√¢y. is_plant ph·∫£i l√† true n·∫øu ƒë√¢y l√† c√¢y/l√°.`;
            } else if (mode === 'soil') {
                return commonInstruction + `\n\nH√£y ph√¢n t√≠ch h√¨nh ·∫£nh n√†y ƒë·ªÉ ƒë√°nh gi√° ch·∫•t l∆∞·ª£ng ƒë·∫•t/gi√° th·ªÉ, ƒë·ªô ·∫©m ho·∫∑c n·∫•m m·ªëc. is_plant ph·∫£i l√† true n·∫øu ƒë√¢y l√† ·∫£nh ƒë·∫•t/gi√° th·ªÉ. Ch·ªâ ƒë·∫∑t is_plant: false n·∫øu ·∫£nh l√† v·∫≠t th·ªÉ ho√†n to√†n kh√¥ng li√™n quan (nh∆∞ con ng∆∞·ªùi, ƒë·ªì v·∫≠t trong nh√†).`;
            }
        }
        
        /**
         * Th·ª±c hi·ªán API Call v·ªõi Backoff.
         */
        async function fetchWithExponentialBackoff(payload, maxRetries = MAX_RETRIES, initialDelay = INITIAL_DELAY_MS) {
            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(API_URL_BASE, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (response.ok) {
                        return response.json();
                    }

                    // X·ª≠ l√Ω l·ªói 429 (Too Many Requests) ho·∫∑c c√°c l·ªói server kh√°c ƒë·ªÉ retry
                    if (response.status === 429 || response.status >= 500) {
                        const delay = initialDelay * Math.pow(2, i) + Math.random() * initialDelay;
                        console.warn(`Retry ${i + 1}/${maxRetries} after ${Math.round(delay)}ms for status ${response.status}`);
                        await new Promise(resolve => setTimeout(resolve, delay));
                        continue; // B·∫Øt ƒë·∫ßu v√≤ng l·∫∑p ti·∫øp theo (retry)
                    } else {
                        // N·∫øu l√† l·ªói client (4xx) kh√°c 429, kh√¥ng retry
                        const errorData = await response.json();
                        throw new Error(`API Error ${response.status}: ${errorData.error?.message || response.statusText}`);
                    }

                } catch (error) {
                    if (i === maxRetries - 1) {
                        // Throw n·∫øu ƒë√¢y l√† l·∫ßn th·ª≠ cu·ªëi c√πng
                        throw error;
                    }
                    // N·∫øu l√† l·ªói m·∫°ng, c≈©ng ch·ªù v√† retry
                    const delay = initialDelay * Math.pow(2, i) + Math.random() * initialDelay;
                    console.warn(`Network or other error: ${error.message}. Retrying in ${Math.round(delay)}ms.`);
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }
            throw new Error("Failed to fetch from API after multiple retries.");
        }


        /**
         * B·∫Øt ƒë·∫ßu qu√° tr√¨nh ch·∫©n ƒëo√°n (API Call cho h√¨nh ·∫£nh)
         */
        window.diagnosePlant = async () => {
            
            if (!base64Image) {
                showMessageBox("L·ªói ·∫¢nh", "Vui l√≤ng ch·ªçn m·ªôt file ·∫£nh tr∆∞·ªõc khi ph√¢n t√≠ch.");
                return;
            }
            
            // ·∫®n k·∫øt qu·∫£ c≈©, hi·ªán loading
            resultsSection.classList.add('hidden');
            diagnoseButton.disabled = true;
            loadingIndicator.classList.remove('hidden');

            const systemInstruction = getSystemInstruction();

            const payload = {
                contents: [{
                    parts: [
                        { text: "Ph√¢n t√≠ch h√¨nh ·∫£nh n√†y theo h∆∞·ªõng d·∫´n h·ªá th·ªëng." },
                        {
                            inlineData: {
                                mimeType: imageMimeType,
                                data: base64Image
                            }
                        }
                    ]
                }],
                systemInstruction: {
                    parts: [{ text: systemInstruction }]
                }
            };
            
            try {
                const jsonResponse = await fetchWithExponentialBackoff(payload);
                
                // L·∫•y ph·∫ßn text (ch·ª©a JSON string)
                const jsonString = jsonResponse.candidates?.[0]?.content?.parts?.[0]?.text;
                
                if (!jsonString) {
                    throw new Error("API response was empty or malformed.");
                }

                // S·ª¨ D·ª§NG H√ÄM TR√çCH XU·∫§T JSON M·∫†NH M·∫º
                const result = extractJsonFromText(jsonString);

                // Hi·ªÉn th·ªã k·∫øt qu·∫£
                displayResults(result);

            } catch (error) {
                console.error("L·ªói trong qu√° tr√¨nh ph√¢n t√≠ch:", error);
                showMessageBox("L·ªói Ph√¢n T√≠ch", `Kh√¥ng th·ªÉ ho√†n th√†nh ch·∫©n ƒëo√°n. Vui l√≤ng ki·ªÉm tra l·∫°i k·∫øt n·ªëi ho·∫∑c th·ª≠ l·∫°i. Chi ti·∫øt: ${error.message}`);
            } finally {
                loadingIndicator.classList.add('hidden');
                diagnoseButton.disabled = false;
            }
        }

        /**
         * Hi·ªÉn th·ªã k·∫øt qu·∫£ ch·∫©n ƒëo√°n l√™n giao di·ªán
         */
        function displayResults(result) {
            resultsSection.classList.remove('hidden');
            const mode = analysisModeSelect.value; // L·∫•y ch·∫ø ƒë·ªô hi·ªán t·∫°i

            // Ki·ªÉm tra is_plant l√† false ho·∫∑c kh√¥ng c√≥ ƒë·ªß d·ªØ li·ªáu ch·∫©n ƒëo√°n
            if (result.is_plant === false || (!result.status && !result.diagnosis)) { 
                
                complimentCard.classList.remove('hidden');
                diagnosisContent.classList.add('hidden');
                
                let defaultCompliment;
                if (mode === 'soil') {
                    // Th√¥ng b√°o s·ª≠a ƒë·ªïi cho ·∫£nh kh√¥ng ph·∫£i ƒë·∫•t/gi√° th·ªÉ
                    defaultCompliment = "Oopsie, h√¨nh nh∆∞ ƒë√¢y kh√¥ng ph·∫£i ·∫£nh ƒë·∫•t/gi√° th·ªÉ r·ªìi. C·∫≠u th·ª≠ l·∫°i nh√©! ‚ú®"; 
                } else {
                    // Th√¥ng b√°o m·∫∑c ƒë·ªãnh cho ·∫£nh l√°/c√¢y
                    defaultCompliment = "PotPal kh√¥ng ch·∫Øc ƒë√¢y l√† c√¢y tr·ªìng, nh∆∞ng ·∫£nh n√†y nh√¨n c≈©ng ƒë∆∞·ª£c ƒë√≥! üíñ"; 
                }

                // D√πng compliment c·ªßa AI n·∫øu c√≥, n·∫øu kh√¥ng th√¨ d√πng default compliment
                complimentText.textContent = result.compliment || defaultCompliment;
                resultsTitle.textContent = "PotPal 'b·ªëi r·ªëi' üòµ‚Äçüí´";

            } else if (result.is_plant === true || (result.status && result.diagnosis)) {
                // N·∫øu l√† c√¢y tr·ªìng/ƒë·∫•t v√† c√≥ ch·∫©n ƒëo√°n
                complimentCard.classList.add('hidden');
                diagnosisContent.classList.remove('hidden');
                resultsTitle.textContent = "K·∫øt Qu·∫£ Ch·∫©n ƒêo√°n";
                
                // C·∫≠p nh·∫≠t nh√£n
                modeLabel.textContent = mode === 'leaf' ? 'T√¨nh Tr·∫°ng L√°' : 'T√¨nh Tr·∫°ng ƒê·∫•t';
                modeDiagnosisLabel.textContent = mode === 'leaf' ? 'Ch·∫©n ƒêo√°n S∆° B·ªô' : 'ƒê√°nh Gi√° T·ªïng Quan';

                // C·∫≠p nh·∫≠t n·ªôi dung ch√≠nh
                resultStatus.textContent = result.status || "Kh√¥ng x√°c ƒë·ªãnh";
                
                // Th·ª≠ ƒë·ªãnh d·∫°ng m√†u cho Status
                let statusClass = 'font-extrabold ml-2 ';
                const statusLower = result.status ? result.status.toLowerCase() : '';
                if (statusLower.includes('kh·ªèe m·∫°nh') || statusLower.includes('t·ªët') || statusLower.includes('t∆°i x·ªëp')) {
                    statusClass += 'text-primary-green'; // M√†u xanh m·ªõi cho tr·∫°ng th√°i t·ªët
                } else if (statusLower.includes('nh·∫π') || statusLower.includes('thi·∫øu ch·∫•t') || statusLower.includes('ƒëang ph·ª•c h·ªìi')) {
                    statusClass += 'text-yellow-600';
                } else {
                    statusClass += 'text-red-600';
                }
                resultStatus.className = statusClass;
                
                resultDiagnosis.textContent = result.diagnosis || "PotPal ch∆∞a th·ªÉ ƒë∆∞a ra ch·∫©n ƒëo√°n chi ti·∫øt.";
                
                // X·ª≠ l√Ω Markdown g·∫°ch ƒë·∫ßu d√≤ng t·ª´ recommendations
                const recommendationsText = result.recommendations || "Kh√¥ng c√≥ khuy·∫øn ngh·ªã c·ª• th·ªÉ.";
                
                // Chuy·ªÉn ƒë·ªïi Markdown list th√†nh HTML list
                const htmlList = recommendationsText
                    .split('\n')
                    .map(line => {
                        line = line.trim();
                        // Ch·ªâ parse c√°c d√≤ng b·∫Øt ƒë·∫ßu b·∫±ng g·∫°ch ngang v√† d·∫•u c√°ch th√†nh <li>
                        if (line.startsWith('- ') || line.startsWith('* ')) {
                            return `<li><i class="fas fa-check-circle mr-2 text-pink-500"></i>${line.substring(2).trim()}</li>`; // Th√™m icon check-circle
                        }
                        // X·ª≠ l√Ω c√°c d√≤ng kh√¥ng ph·∫£i g·∫°ch ƒë·∫ßu d√≤ng nh∆∞ ƒëo·∫°n vƒÉn (p tag)
                        if (line) {
                            return `<p>${line}</p>`;
                        }
                        return '';
                    })
                    .filter(line => line)
                    .join('');

                // D√πng ul/li n·∫øu c√≥ list, ng∆∞·ª£c l·∫°i d√πng raw text trong p tag
                resultRecommendations.innerHTML = htmlList.includes('<li>') ? `<ul class="list-none space-y-3">${htmlList}</ul>` : `<p class="whitespace-pre-wrap">${recommendationsText}</p>`;
                resultRecommendations.className = 'text-gray-700 leading-relaxed text-base';


                // G·ª£i √Ω S·∫£n ph·∫©m
                supplementList.innerHTML = '';
                if (result.supplements && result.supplements.length > 0) {
                    result.supplements.forEach(item => {
                        const li = document.createElement('li');
                        li.className = 'flex items-start text-base';
                        li.innerHTML = `<i class="fas fa-flask text-blue-500 mr-3 mt-1"></i> ${item}`; // Th√™m icon flask
                        supplementList.appendChild(li);
                    });
                    supplementContainer.classList.remove('hidden');
                } else {
                    supplementContainer.classList.add('hidden');
                }
            } 
        }
        
        // Th√™m h√†m init ƒë·ªÉ ƒë·∫£m b·∫£o n√∫t Diagnose c√≥ th·ªÉ ƒë∆∞·ª£c k√≠ch ho·∫°t n·∫øu c√≥ API key
        function initApp() {
            // Ch·ªâ c·∫ßn ki·ªÉm tra xem c√≥ ·∫£nh ƒë∆∞·ª£c ch·ªçn kh√¥ng
            if (base64Image) {
                diagnoseButton.disabled = false;
            } else {
                diagnoseButton.disabled = true;
            }
        }

        window.onload = initApp;

    </script>
</body>
</html>
